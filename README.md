# Микросервис для счетчиков статистики.

API для сайта. 


## Как запустить сайт

Проект полностью докеризирован. Запустите сайт:

```sh
docker-compose up 
```


### Переменные окружения

Часть настроек проекта берётся из переменных окружения. 
Чтобы их определить, создайте файл `.env` рядом с `Dockerfile`
и запишите туда данные в таком формате: `ПЕРЕМЕННАЯ=значение`.

Используются следующие переменные окружения:
- `SQLALCHEMY_DATABASE_URL` - URL, в котором содержатся данные о БД

Для переменной установлено значение по умолчанию


## Документация по API

### Регистрация/аутентификация пользователя с использованием JWT
- Права доступа: `Любой пользователь`
- URL: `api/auth/users/`

Данные введенные при добавлении участника используются для регистрации, либо авторизации.

### Создание трекера отслеживания карточки 
- Права доступа: `Авторизованный пользователь`
- URL: `api/user/track_create/`

Создается объект, в котором указан артикул отслеживаемого товара, время начала 
и конца отслеживания, а также интервал отслеживания


### Сохранение статистики

- Метод: `POST`
- URL: `api/save/`

Создает статистику. Принимает на вход:

`date` - дата события
`views` - количество показов
`clicks`- количество кликов
`cost` - стоимость кликов (в рублях с точностью до копеек)
Поля `views`, `clicks` и `cost` - опциональные.

Пример запроса:
```sh
curl -X 'POST' \
  'http://127.0.0.1:8000/api/save/' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "date": "2022-12-06",
  "views": 2,
  "clicks": 7,
  "cost": 6
}'
```
Пример ответа:
```sh
{
  "cost": 6,
  "id": 4,
  "date": "2022-12-06",
  "views": 2,
  "clicks": 7
}
```


### Показ статистики

- Метод: `GET`
- URL: `api/get/`

Принимает на вход:
`start_date` - дата начала периода (включительно)
`end_date` - дата окончания периода (включительно)
Отвечает статистикой, отсортированной по дате.

Пример запроса:
```sh
curl -X 'GET' \
  'http://127.0.0.1:8000/api/get/?start_date=2022-12-05&end_date=2022-12-06' \
  -H 'accept: application/json'
```

В ответе статистика, отсортированная по дате. Выводятся поля:

`date`- дата события
`views` - количество показов
`clicks` - количество кликов
`cost` - стоимость кликов
`cpc` - средняя стоимость клика
`cpm` - средняя стоимость 1000 показов

Пример ответа:
```sh
[
    {
    "date": "2022-12-06",
    "views": 10,
    "clicks": 25,
    "cost": 100,
    "cpc": 4,
    "cpm": 10000
        },
    {
    "date": "2022-12-06",
    "views": 5,
    "clicks": 5,
    "cost": 5,
    "cpc": 1,
    "cpm": 1000
    }
]
```

### Сброс статистики

- Метод: `DELETE`
- URL: `api/delete/`

Удаляет всю сохраненную статистику

Пример запроса:
```sh
curl -X 'DELETE' \
  'http://127.0.0.1:8000/api/delete/' \
  -H 'accept: application/json'
```


## Технологии
docker, docker-compose, fastapi, alembic, sqlalchemy 